# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

from langbot_plugin.api.entities.builtin.platform import message as platform_message
from langbot_plugin.api.definition.components.common.event_listener import EventListener
from langbot_plugin.api.entities import events, context


import zipfile
import tempfile
import re
import base64
import io
import tempfile
import pillowmd
import asyncio


response_text = None #全局变量，导入消息

#获取配置
get_url = False
get_markdown = 2
#调试输出
test_mode = True
#阻止回复
breakout = True

def load_style_from_zip_bytes(zip_bytes):
    """
    从ZIP二进制数据加载样式
    
    Args:
        zip_bytes: ZIP文件的二进制数据
        
    Returns:
        MdStyle对象
    """
    # 创建临时目录
    temp_dir = tempfile.mkdtemp(prefix="pillowmd_zip_")
    
    try:
        # 使用BytesIO处理二进制数据
        zip_buffer = io.BytesIO(zip_bytes)
        
        # 解压ZIP数据到临时目录
        with zipfile.ZipFile(zip_buffer, 'r') as zip_ref:
            zip_ref.extractall(temp_dir)
        
        # 从解压后的目录加载样式
        style = pillowmd.MdStyle(temp_dir)
        return style
    
    except Exception as e:
        # 清理临时目录
        import shutil
        shutil.rmtree(temp_dir, ignore_errors=True)
        raise e
    
def image_to_base64(image):
    """
    将PIL Image对象转换为Base64编码的字符串
    
    Args:
        image: PIL Image对象
        
    Returns:
        Base64编码的字符串
    """
    # 创建内存缓冲区
    buffer = io.BytesIO()
    
    # 将图片保存到内存缓冲区（PNG格式）
    image.save(buffer, format="PNG")
    
    # 获取二进制数据
    image_data = buffer.getvalue()
    
    # 转换为Base64编码
    base64_string = base64.b64encode(image_data).decode('utf-8')
    
    return base64_string

async def render_markdown_async(style, markdown_text):
    """
    异步渲染Markdown，避免事件循环冲突
    
    Args:
        style: MdStyle对象
        markdown_text: Markdown文本
        
    Returns:
        渲染结果
    """
    try:
        # 在单独的线程中运行同步的Render方法
        loop = asyncio.get_event_loop()
        result = await loop.run_in_executor(None, style.Render, markdown_text)
        return result
    except Exception as e:
        print(f"渲染Markdown时出错: {e}")
        raise

class DefaultEventListener(
    EventListener
):

    async def initialize(self):
        await super().initialize()
        
        @self.handler(events.NormalMessageResponded)
        async def handler(event_context):
            #获取配置
            config = self.plugin.get_config()
            try:
                file_config = self.get_config()['config_file']
                file_key = file_config['file_key']
                file_bytes = await self.get_config_file(file_key)
            except:
                file_bytes = b'PK\x03\x04\x14\x00\x02\x00\x08\x00\xb0\xbbp[\xa7\xd9\xfb\xa4K\x06\x00\x00\xce\x16\x00\x00\x0c\x00\x00\x00elements.yml\xedW[o\x1aG\x14~\xf7\xafX\x05\xf5\xadD@\xe2\\\x90\xfa\xda\xaa\xcf}\xac\xaa\x9a\x18\xe2\xa2pq\t\xa8\xf6\x1b\x8e\x83\r^\x1c\x90\x03\xb1\rD\x86\xc66\xc4\x8e\x8d\x9386\x97\x85\xfc\x97hgv\xf7\xc9\x7f\xa1\xe7\xcc,{\x81\xb5[\xa5\xce\x9b\xa5(\xc2\xb3\xdf|\xe7:\xdf\x9c\t\xc5\x02\x8f"!\xbf\x90L\xa4B\x82K\xa0[mR\xdc\'\xc5\xb6Rj\x91\xcc\xb2rZWJ;4[T\x97\xf3t\xbb=5\xe5\x12~\xfa\xf9G\xda\xf9@w^j\x99uep\x0c+\xf3\x819 \xf0z\x04\xcbG\xbay\xa6T\x9ek\x8dO\xb4|r!\xe5\xe5\xce:\xe7\x84u\xb9\xd3\x9b\x8f\xcdq\x18|2\xd6\xe17\xcd\xa5i-G\xaaC%\xb7\xaa-\x0f\xb4ZZ\xdd_"\xb5\x16}\xb5*\xf7\xcfH\x11H^\x90\xb5\xba\xdcY\xfb\x92\xae\xfd\xaeH\xafH\xe1\xfcK\xfa\xf5\x85\x94\xf5\xaa\x9f\xce\xe9\xd1\xde\x85\x94\x03\x87\x82\xa9D \x19\x8e\xc7\xfc\x82\xe7\xf6\xf4\xa4W\xb4]\x90;i\xd2i\xe2\xef\xfc\x92\xd2?\x82um\xf3\x14\x9dY/\xcb\x83u\xf0Pin\x00\x11\xc4\x16\t,>\n\xcc>\xf9%\xf4g*\x14\x9b\x858oy\x05\x9fpG\xb8+L\x0b\xf7\x84\xfb\xc2\x03\xe1!\x84~\x0b\xa0\xe0\x05)\xb4\xb5t\x0e\x9c\x00\x8b<\n\xbaqDKC\xad\xd1#\xbd\x02\x06\xb8\xd5\x06\xd3r\xe7@\xee\xef)o{\xb4.i\x95\x12\x91\xd2\xe0\t9\xdaT\xde\xed\xcb\x9d\x0f\x98\xae\xa1\x08\x01\xa2!\xc3\x18\x0b3\xaf\xf5\xb7\xd4\xe3]\xf0O\xff\xfc%\xbd\x0f\xff\x04\xddV\xf9\x84\xa3\xe8\xc7\x16}^\x80?\x81S[-\x90\xcf\x19\xad\xd1\'\x1by\x03\x06>\xa8\xab,^\xa8uv\x9b\x9c\xac\xf0<\xc8\x83\xcfX\x0b\xe63&\xa7\x96\x86\x84c\xae\xa4\xfa\xd4\x14\xa6a.\x11O\xc5\x82~\x88\x967\x84\xde\x03S\x82\x10\x8d\x07!9\xd8\x03\x1e\xbf\xc0y \x99\xb0\x91\x1b\x95\x075\xf0\x9ao\x02\xbb^\x03\xb3[q\xc4\x00#\xd8h\x9f\xd3z\x97\xae\x1f\xab\xab\x07\xe4\xfc=x\x84V0\r\xe9\x1c\x15\xdfB\x0e\xe5\x8eh\xba\xe0\x12\xc8\xe0%"~\xf0\xf0v\xb2\x02\xb0\x8d\xcbY\x84\x05\x03\xc9\x80\x1f\x7f\x08B8:\x07\x055\x03\xbb\r\x8dy\xcb\x08\x8e{\xc5\x80\x91\xf8\xec\x13\xbf\xf08\x10y\x1a\xe2\xfd\xa4\x95\x96\xc8q\xe5B\xaaX{\x0bL\xaa\xed=\xbeM\xfd\xfb\x90T{\x0c\x83\xdd\xafU\n\xbc]Ia\x8b\xe4_\xa9\xe9<\xff\xc1\xfd\x00\xcf\x1b\x87$\x93\xa1\xad\x06\x91\n\xfa\x92\x07\xd8\xd5FK\xd9\xedQ1\'K\x1d\x0e\xd1?z\x8d\x8f\xb0\xac\xbd\xec\xc16\xdbw\x9f\xb9y\x1bR:pF\xdd1Y2Y\x9e\xeaEupj\xb5\x07\r\x80}\xb2\xb2\x0e\xc7p\x01\xbe\xc1\xd9s\xe6\xba;\xc9\xb5p\x05\xd7\xe2U\\\xd3_\xe5\xd7U\x91\xde\xfb*\xef.g\xd4\xdb\xdd\xdev\xde\xab\xda\xce\xc5\x1bO\xe0\xbf\xd96\xd6(\\e\xf5.\xe6\x9f"\xa1\xc7Iwj\x1eZ\xf3w\x8fw\xd4\x93\xe4\x1c\xc4aMmn\x18m9\x822\xdc]+n\xd8\x9c\x00\xb9\x83\xf1\xbfb\x0cy\xdf\xc6(\x8e3\xeav}#\x14\x18\x1d\xe73\xa8\x1e\x98 q\x1c\x94\x08\xcf\xfdaDq\xc7\xb0Y\xf8\xe8\x10\x05\xc32\xe0=+\xd0\x91\xd10\xfe\xd0\xc69\x11G4\x1c\x0c\xe2\xc5\x06\xc8i\xd3\xcd#\xd0y\x1df\xd4\xe1:\x8f\xb3\x9e\xf0\x94\xdb\xae\x18F\xf1\xb8\xa1\x11\xcc\x015l\xda!A\'&q\x9ci\xdc\x1e/\x9a\r\x12\x9c\x80\x88\xe3\x90\xc4\x84\xdb\xa3j\xd9a\x0e\xa8q\xa6\xa0\x13\xd3\x84\xdb\xd1\t\x9f\xb0>:\xc4\xa8\x8f:\xec*\xd2\x96U!\xa1Pp\xcbX\x0f/\xbfSH\xf7#\x9e\xd4\xd1\x8a\x0f0N\'\x18nj\xa8\xa1,UH\xb5\xce\xb7@\x01\xa1\xc2\xea\x9b%\x92;\xc0\x19BO~\xc2\xcd\xcf\xb9\x8f\'\x1e\x82\x18\xd3i\x96\xfb\xa0\x05\x85\x89\xef\x886\x94\x11\x87\xde}\x93\x0cWh\xbd\xeb_\xd5\xde\xf5\x1f\xf5\xdeu\xad\x8a\xef\xbaV\xcdw}\x03\xd5w}\x03\xdd7u\xc5m\\\x00S\xc1\xd0l\x1c\xe6\xcd\xd0S6\x16\xbd\xc9h{\'\xd6\x99$\x19\x9f\x87\xd1\xebQ<\x99\x8cG\xd9\xf8\x07\xe3\xdb\x81"\xbeS\x0eE\x18h8\x9e\xbc\x7f\x86S\xcd\xf2\x00\xc7o6Cj\x8d.n\x87\xcd\xc8\xca%\t\xfc\xd3\x1ag\xdar\x0b$\x89\xed\xc8\xc2\\Lk\xef\xe4\xae\x08>c\xdb\xea\x97\x9dN\xca\xc7h\xe6\n\xb0?\x04\xb3\xb87\xbb\x82\xc3&\xbft\xec\x06qr\xc4\xd1X\x87\xc1:\xdcd8\x8f\xefV`\x91\x93r\x13\xc6\x05\xf5\xeboVq\xb3\xdae8t\xc6\xadOY\x10\x8a[\xdf7q\xa59n\xb4\xcf\x94\xfc\xc0*\xfd\x82\xfa\x19\xde\x02}yPV\xa4\xb70\xa6\x82\xd3J\xf5\x94\xbe\xd8\xc3\x91up\x0c9"\xed.\xe9\x95H\xbeGvv,d.!\x1c\x9b\x8d\xa4\x90\xd1\x14\xa56\xbb\xab{3le\x86fA\xc933\xf8\x14\x9aA\xf1\xe7\xe7\x89\xbd\x88\xc0\xbcz\x96\x01\xdb F\xb4\xb1\x82\n\xd2}\x8du\xb0\x9cf8\xf8t\xb3\x0e\xd7=\xb6S\x15^)=\xfa\xa1\x01\xf9\x1bm\xc9Y\x07x\xdd$By\x9es"Yk!\xdd\xca6~fN\xd8\xdc\xb7K%\x17I\xb8\x9f\xac\xb9C\x03l\x9d\x8d\xed\x98\xb0\xcb.*|\xac\x14\xf3\xe6\xe4\x0b\xda\x84\xef5\xb6y\xd42\xb9\xeb\xab\xa1Wpy\xfd\xe0\x0e?\x81\xbc6d\xb7IN\xa0\x9cU\xb5\x91\x9f\x98p\r\xcdd\xb3\x14)<\xc3WK?\x03\xe55&-\xc8,\x8eV&z!\x12\x8e\x86\x93\xa3G\x9fy\xcc\xb5\xed"\xc9\xe2m\xee\xb9\xed\xb3\x89l\xf1\xc5\xc2\xf7\xfc\xc4c\xaax}i\xf9\x14\x1e$\xd1@\xe2\t\x0e\x1a\x18N\xe5\xb9\xcf\xf3\x9d\xc5\xcc\xa2\xcd\xcc\xe2\xb72\x13\r\xc7\xd8\xd1\x877\xd8I\x81\xf7:\xcf\x18\xf6\x1e\\\x87\x99\xac\xd2k\xd2v\x89yC\xab\xa7\xda\xe1\x96\xb5d@\x10X\x18\x11\xec6\xad\x04\x02\x03\x19\x07\xd9r\x8a\x87M[\x15\xcd\xb3\xce\x87.\xf3\xb4\x8bN\x05g\xff\x19\xaa\xc0G\x10g\x90\x85\x8e\x8f!\x93f\xcd\xf1\x91[\x1dM"\xce\x84\xfa\x00i@/3l\x1d!M\xde\xcb\xa3\x19\r\x91\xba\xabx\x7f\x8f\xbb\xca\x95\xdd\xa6\xd2\xa4W\xb6\xaa4\x7fM\x8eT:o\x11m\xf1\xff\x8b\xf6\x8d \xdf\x08\xf2\x8d \xdf\x08\xf2\x8d #\xf0\x1fPK\x03\x04\x14\x00\x00\x00\x00\x00\xb0\xbbp[\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\x00\x00imgs/PK\x03\x04\x14\x00\x02\x00\x08\x00\xb2\xbbp[\xb8\xcd]\xc3\xb6\x00\x00\x00\x1c\x14\x00\x00\x13\x00\x00\x00imgs/background.png\xeb\x0c\xf0s\xe7\xe5\x92\xe2b``\xe0\xf5\xf4p\tb``n\x01a\x0e6\xa0\xc8O\xbf\xff\xd6\x0c\x0c\xc2\x8f=]\x1cC*\xe6\xbc\xbd\xee\xc8x\xc0A\xa0eC\xee\xdf\xeay\xc2NI\x8d\xe2\xf7\xb7\xc9\x02UY\xee\x7f\x02$}\xdb\x04\x18\x18\x14N\t010\xb8H:104h8s00\x08\xa4r020,\xe2Qd`p\x98\xa2\xc8\xc2\xc0\xd0a\x044\x9e!pT\xf1\xa8\xe2Q\xc5\xa3\x8aG\x15\x8f*\x1eU<\xaaxT\xf1\xa8\xe2Q\xc5\xa3\x8aG\x15\x8f*\x1eU<\xaaxT\xf1\xa8\xe2Q\xc5tR,r\xf7.sz07\xcb\xe1\x83Gr\x812\x0c\x9e\xae~.\xeb\x9c\x12\x9a\x00PK\x03\x04\x14\x00\x02\x00\x08\x00\xb0\xbbp[\x1d\xaf\xc3\xce}\x05\x00\x00\xfa\x0b\x00\x00\x0b\x00\x00\x00setting.yml\x8dV[S\xdbV\x10~\xd7\xaf\xd0\xd0\xe9S)\xb5I\xdc2<6\x94NfH\x1e\x02\x99I&\xc3t\x14K\x80\x06!1\xb2\xdcB\x9fDRb\x9b\x98\x98\x0c\x06s1\xc1N\xb85\x17\x9b\x04\x1a\x1b_\xffK\xa2\xa3\xcb\x13\x7f\xa1{tt\xb3q\x9a\x8e\xed\x19k\xcf\xb7\xbb\xdf\xf9\xce\x9e]\x89\xcc\x1c7L\xf7\xa1\xb5U\xe3\xf8\xb4\x8f\xfe\x86\x8e)\x8b\x02\x07\x8f\x97\x8d4ZK\xeb\xb9\x8f\xda\xc5\xbe\xbeU\xe6Y\xb0Q\xbc\xa8\xc8\x80\xd63\x19\xb3\xed\xa3\x8d\x9d\xbf\x88Ek\x17\xf5\xa52\xc5\xc4\x95\x19\t\xe3\xb4f\xdeT\x97\x838b\xa1~\xe7\xe4\x18/\x89\x00\t\x0f\x84\x82\xebF*\xa9\xe7\xdf\xa2L\x85\xa2\xa2RL\x19\xa6\xc3\xa1P\xd0\xbd^\xd1\x0b\x8d\xcbFR\xab\xae\x1a\xfb\x87\xd6\xd2\xba\x9eOiuU\xbbH\x1a\xd9\x93{\x97\x8d\x14\x15\xe3\x04\x81\x17\xa7\x87\xe9)F\x88q\xe0\x8b\x125\x94-i\xd5w\xff\xe9FMI\xa22\xce\xff\tb\x0cF\xc0K\x7f\xf7J\xdfL\xa0w9\xad\xb9\x8e\x0e\x8e\xd1i\x86\xa2\x14^\x11\xb8\xf0\xa8\x07\xfc\tS\xd3\xaa\xaaQ;\xd6\x0b\t\xeb\xe5V\x07\xdcF\x0f\xfa\xe8\x08\x0e\xab\xd5\xd2\x1e\x1a\xe2\xe3\xbd\x06\xd0\xd7|\xf4u\x12;\xd5\x1bMq\x0b\xf32\x17\xc3\x1a\xba.w\x18\x05\xdcB\x03C\xe0g\x16O\xccV\x0b52\xc6\xfb:\xec\x1a\xa5\x97\xf5\xa7o\xcdb\x1aD\xd0\xea\xaf\x8c\xc2\x12\xec\x98p5\x1a\x7f\xeb\xd9\x16RW\x8dg\tP\x9c\xe5~\x16\xa4\xe8\xacO#\x1c\xb1\xc3\xf9\x9eh/\xd7\xc9Df1\n\xb3E\x993\xb3uaV\xf6(\xc1\xb7U\x8e\x1c[\xdc\xb3i\xd5\x15\xc7\xc6\x06lO\x1d\x1b\xb5\x803\xdfb\x16\xec\xb3\xc7k\xf7\xcc\xe69Z\xdd\x00\x16h\xf9\xb1q^\xd0\xf3*$\xb76\xda\xa8vD\xce\r\xeah\x91\x99\xe1\xf8\x01E\x99\xea\xeb:<\xa2\xech/T\xe0\xcc\xba\x04\x05\xe8\xf8\xc4\xcd{\x13\x7fH\xb7\x18e\xe6\xfb;\xdct\\`d\xd7\xd1\x93\xd7\xf1\xc5\xba\xf5J\xe0(F@\xbe\xbacwF\xf8\x98\xc2\x88Q\\k!\x1f\xb7\x97\x03\xb5|\x11=\xfc\xdd\x91/\xe1A\xc9\x80pS\x92<7\xc6\x8b\\\x17\x1a\xd8\xc2\x9d\x01\xf5\xac\xdc\xb9}8\x1d\x900\x81\xb8\x8bQ^\t,^\xb3\x8f\xb0\xb1\x01\x97\xc4Y\xa7\xe6\x99i\x0e\'\xb9!\t\xf8\x8a?\x08\xf5\xd3\xf8;\x89\x81\xc9\'V\xf1\x1f\xe3\xcd\xa6Qk[/\xf3f\xea\x83\x87\x1e\xc7\xf7\x17\xe4\x99\x8a\x0b\xc2o\x98@_\x17^/T@O\xa8U\x0fA\xa3\xd2\x0bX\xa0\x7f\xa0YIQ8\x96\x18\xcd\xed\x1d0\xda\x176.J2\xcb\xc9\x1c;\x06|G$\xc5g\x04\x1f\xccG\xcf\x15P-\x83\x929P\x00\xa5V\x8df\xc9xt\xe1\x10\xfb\x9ak>\xf5\x7f\\o\xc7\xe7\x1er\xb2\xeb=\x18\x89\xf4;\xbf+1\xe0O\xa6\xe2\x04\xb0E\xbe+B\x94y\x06\x1a\xaa\xdd\xacH\xea\xfe\x08\x11\xd2V\x1c\xd560\x1a\x83\xc7\xe7\x05^\t\xaa\x1e\xfe1\xd4\xef\xfc\x02\x0e\xc9\'(\xf5\xc1\x17?PA]\xc9\xae\x87\xfa\xed\xefdG\xf19\xf9\\\xa7\t|o|e\xf0\xce:\x1d\xc8\xfdq\x93\xb9\xd5wEKR\x7f\xdd\xe40|\x82[P\xbe\x00\'=&\x80\xed\xadW0\x01\xa1o\xc7\xc5\xcc\xbf\xea\xe0\\\x7f\xe2F)\x1d\\\xbc\x9avz\xdd~\xcd(\xaa\x0e\x1b\x8c\xfcUfX\x9e\x13\x95_D\xb6\x87\x93\x91}\xafo\x97,u\xc7\x99\x07\xc9\xd3\xe0\x90\x80\x91J"\xa1\xcc\x16Jo\xe2\xe1\x99W\x8dz\x12\xc7\x86\x1a\x9f\r*\xe2\x94\x92\xb5\xde\xd2\x9f\x1d\xbaJ\xfb\xad\xaa{\x8f\xe1!(\x89!\xcf\xcd\xefSd\x93\xbc\x18\xe3d\xd8%\xeb\x8a\xe3\xbaE\xc0\r~\xb8\x17Ov\xf7{G\x1f\x9e\x15z\x1f.\xee\x1cW*\xcf\xa7\xd8}\xc6\xdd\xd4:\x0e\xda\'\x18t\x0bG\x86\xec\xea\x8b\x0cv\x93\xebp\xf6\x0b\xb7#e\x8f\xba\rzQ27\xc7\xc8\xb3W;\x00\xa9\x8e\x83\x84~v\xe2@\t\xd2\x9f\x8dvw\r\xe2:\xc6\xbf\x1b\x17\xda\x05/\xda\xb3\xf9\x01l\xa1;4\xda[\x83G\xe8{\x0b0\xb3@\x14\xe3\xa0\x06m\x16\xe6\x00\xbc~i\xd5\x9ay\xbe\xef\x1b3g\x97\x8d\xdd\xc5 \x0e\xfa\xffU\x1cL\x04\xbb?\xc6\xb8\xa8$\xb2\x98n\x0cr\x07&S\x7f_\\\xe4\xf1\xd8\xb4\x9f\xec\xfeq\x90\xc0\xfd\xc3\xa9V\xdc\xb0\xc8\\\xbd\x7fC\x92e.\n\x83\r0\xf6\xea}<\x8b\x972\xc6q\xddJ@\xbbN\x03\x1b\xa46Hn\xb4\xf6\x1cr\x93UX\x02N\x9dK+\xde\x12Ls\xad\xb9\n\xbc\x8d\xed\x16\xd4\x8e^\xceR4\xed\x11\x1c\xa6\xbf\xb3_;P\xabd6\xcb\xd6\xee\xb2U\x7f\xee\xba&\xcd\xc4kT=\x82K\xe3\xc1\xf5\xad\x16d\x80nk\xe5J\xa0+\x84\xb7\xf2\xaay\xb4\x04A\xbeu\xdd@\x8e\x87LtvZ\x96\xe2\xech\\\x8c\x0e\xd3"\xcc\x19\\M\x8f\xd3\xfav\x19%\x9a\xfa\xc6)\xf6\xaco\x99\xa5\x03\xa0\r\xdcnK"\x87\xb7ao\x00^\x1c\xb5f\x1bD\n:|V\x1f\x11#Jn\x93\x9c(\x7f\x02\xa5e\xec\x96Ps\x03\xb4\xd0+u\xb4R\xf8\xa4\xe6\xed\xf7\xd7\x81\xf9\xc5O\xea\x1eT\x9fV\xffh\x1f[\x16\x95v\xb4\x8b\x14*_\xa0Z\x16\xb6\xe4\xd1\x800f{\xdbJ\xa4Q\xf1\rZ>$vx\xff\x86\x84\x90Gk\xef\x99\xe5%b\xc4^\x99G\xf0\x07\x08k\xd5\x03\xad\xfa\x1a\x9a\x01\x96\xc9\xa6\x89\xdf\x91JM\xd8>\xdeG;\x8bv_\xdc\x9c\x83\x89\x0c\t\xcd\xf7\xc5\x7f\x01PK\x01\x02\x14\x00\x14\x00\x02\x00\x08\x00\xb0\xbbp[\xa7\xd9\xfb\xa4K\x06\x00\x00\xce\x16\x00\x00\x0c\x00$\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00\x00\x00\x00\x00elements.yml\n\x00 \x00\x00\x00\x00\x00\x01\x00\x18\x00\xdcy\xf4\xcd\rW\xdc\x01\x08 \x80H\x0eW\xdc\x01\x9c\xc9\xeb\xcc\rW\xdc\x01PK\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xb0\xbbp[\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00$\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00u\x06\x00\x00imgs/\n\x00 \x00\x00\x00\x00\x00\x01\x00\x18\x00\x0eh\x13\xce\rW\xdc\x01Z\xacbJ\x0eW\xdc\x01-\x1e\xf2\xcd\rW\xdc\x01PK\x01\x02\x14\x00\x14\x00\x02\x00\x08\x00\xb2\xbbp[\xb8\xcd]\xc3\xb6\x00\x00\x00\x1c\x14\x00\x00\x13\x00$\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00\x98\x06\x00\x00imgs/background.png\n\x00 \x00\x00\x00\x00\x00\x01\x00\x18\x00\x12\xfc\x97\xcf\rW\xdc\x01\xb8\xbel\xd0\rW\xdc\x01\x0eh\x13\xce\rW\xdc\x01PK\x01\x02\x14\x00\x14\x00\x02\x00\x08\x00\xb0\xbbp[\x1d\xaf\xc3\xce}\x05\x00\x00\xfa\x0b\x00\x00\x0b\x00$\x00\x00\x00\x00\x00\x00\x00 \x00\x00\x00\x7f\x07\x00\x00setting.yml\n\x00 \x00\x00\x00\x00\x00\x01\x00\x18\x00\xdcy\xf4\xcd\rW\xdc\x01\x08 \x80H\x0eW\xdc\x01\x9c\xc9\xeb\xcc\rW\xdc\x01PK\x05\x06\x00\x00\x00\x00\x04\x00\x04\x00w\x01\x00\x00%\r\x00\x00\x00\x00'

            global get_url
            global get_markdown
            global test_mode
            global breakout
            breakout = config.get("breakout", True)
            get_url = config.get("get_url", False)
            get_markdown = config.get("get_markdown", 2)
            test_mode = config.get("test_mode", True)
            #重置判断次数
            markdown_number = get_markdown

            response_text = event_context.event.response_text

            if test_mode:
                print(response_text)
            print("-" * 50)

            lines = response_text.split('\n')
            url = ""
            have_url = False
            
            for i, line in enumerate(lines, 1):
                is_markdown, features, Url = self.analyze_line_markdown(line.strip())
                status = "✓ Markdown" if is_markdown else "✗ 普通文本"
                if Url:
                    url += line.strip() + "\n"
                    have_url = True
                
                if is_markdown:
                    markdown_number -=1
                
                features_str = f" [{', '.join(features)}]" if features else ""
                print(f"第{i}行: {status}{features_str} -> {repr(line)}")

            #发送控制

            if markdown_number <= 0:

                #转换操作
                try:
                    style = load_style_from_zip_bytes(file_bytes)
                    # 使用异步方式渲染，避免事件循环冲突
                    result = await render_markdown_async(style, response_text)
                    base64_image = image_to_base64(result.image)

                    if base64_image:
                        print(f"✅ 转换成功")
                        if test_mode:
                            print(base64_image)
                        if have_url:
                            await event_context.reply(
                                platform_message.MessageChain([
                                    platform_message.Image(base64=base64_image),
                                    platform_message.Plain(text=url)
                                ])
                            )
                        else:
                            await event_context.reply(
                                platform_message.MessageChain([
                                    platform_message.Image(base64=base64_image)
                                ])
                            )
                        if breakout:
                            event_context.prevent_postorder()
                except Exception as e:
                    print(f"❌ 转换失败: {e}")
                    # 可以选择在这里发送错误消息
                    # await event_context.reply(f"Markdown转换失败: {str(e)}")
                        
    def analyze_line_markdown(self, line: str) -> tuple[bool, list[str]]:
        """分析单行是否为Markdown格式"""
        features = []

        Url = False
        
        # 检查标题 (#, ##, ###)
        if re.search(r'^#{1,6}\s+.+', line):
            features.append("标题")
            
        # 检查粗体 (** 或 __)
        if re.search(r'\*\*.+?\*\*', line) or re.search(r'__.+?__', line):
            features.append("粗体")
            
        # 检查斜体 (* 或 _)
        if re.search(r'\*[^*\n].*?\*', line) or re.search(r'_[^_\n].*?_', line):
            features.append("斜体")
            
        # 检查行内代码 (`)
        if re.search(r'`[^`\n]+?`', line):
            features.append("行内代码")
            
        # 检查列表 (-, *, + 或 数字.)
        if re.search(r'^[\s]*[-*+]\s+.+', line) or re.search(r'^[\s]*\d+\.\s+.+', line):
            features.append("列表")
            
        # 检查引用 (>)
        if re.search(r'^>+\s+.+', line):
            features.append("引用块")
            
        # 检查链接 ([文字](链接))
        if re.search(r'\[.*?\]\(.*?\)', line):
            features.append("链接")
            if re.search(r'http', line):
                Url = True
           
        # 检查图片 (![alt](src))
        if re.search(r'!\[.*?\]\(.*?\)', line):
            features.append("图片")
            if re.search(r'http', line):
                Url = True
            
        # 检查分割线 (---, ***)
        if re.search(r'^---+\s*$', line) or re.search(r'^\*\*\*+\s*$', line):
            features.append("分割线")

        # 检查代码块开始或结束
        if line.strip() == '```' or line.startswith('```'):
            features.append("代码块标记")

        # 如果有任意Markdown特性，就认为是Markdown格式
        is_markdown = len(features) > 0
        
        return is_markdown, features, Url